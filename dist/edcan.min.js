class Edcan{constructor(){this.default_height=300,this.default_bg="#c9fffa",this.edit_data=[],this.default_output_type="webp",this.init()}init(){console.log("EditCanvas: Initializing...");document.querySelectorAll(".edcan").forEach(((t,e)=>{let a=Math.random().toString(36).substring(2,9);t.id?a=t.id:t.id=a,console.log("UNIQ_ID = ",a);let i=300,d=300;if(t.dataset.size){let e=t.dataset.size.split("x");i=parseInt(e[0]),d=parseInt(e[1])}let s=document.createElement("canvas");s.id="edc-"+a,s.width=i,s.height=d,s.style.width=i+"px",s.style.height=d+"px",s.style.backgroundColor=this.default_bg,s.style.display="block";let o=t.clientWidth;if(o<i){let t=o/i;s.style.width=o+"px",s.style.height=d*t+"px"}else{let t=i/o;s.style.width=o*t+"px",s.style.height=d+"px"}s.addEventListener("dragover",(t=>{t.preventDefault(),console.log("file dragged over")})),s.addEventListener("dragleave",(()=>{console.log("file dragged OUT")})),s.addEventListener("drop",(t=>{t.preventDefault(),console.log("file dropped");const e=t.dataTransfer.files;if(e.length>0){const t=e[0];t.type.startsWith("image/")&&this.handleImageDrop(a,t)}})),s.addEventListener("mousedown",(t=>{this.onPointerDown(t)})),s.addEventListener("mouseup",(t=>{this.onPointerUp(t)})),s.addEventListener("mousemove",(t=>{this.onPointerMove(t)})),s.addEventListener("wheel",(t=>{this.onMouseWheel(t)})),t.appendChild(s);let n=document.createElement("input");n.type="hidden",n.id="out-"+a,t.dataset.out&&(n.name=t.dataset.out),t.appendChild(n),this.edit_data[a]={},this.edit_data[a].canvas_width=i,this.edit_data[a].canvas_height=d,this.edit_data[a].active=!1,this.edit_data[a].zoom=1.001,this.edit_data[a].ratio=0,this.edit_data[a].x=0,this.edit_data[a].y=0,this.edit_data[a].drag_start_x=0,this.edit_data[a].drag_start_y=0,t.dataset.type?this.edit_data[a].output_type=t.dataset.type:this.edit_data[a].output_type=this.default_output_type}))}handleImageDrop(t,e){let a=new FileReader;a.onload=e=>{let a=e.target.result,i=new Image;i.src=a,i.onload=()=>{this.edit_data[t].img=i,this.edit_data[t].x=0,this.edit_data[t].y=0,this.edit_data[t].ratio=i.width/i.height,this.edit_data[t].zoom=i.width/this.edit_data[t].canvas_width,this.renderOnCanvas(t)}},a.readAsDataURL(e)}renderOnCanvas(t){let e=document.getElementById("edc-"+t).getContext("2d"),a=this.edit_data[t].img,i=this.edit_data[t].x,d=this.edit_data[t].y,s=this.edit_data[t].zoom;console.log(e.canvas.width,a.width,e.canvas.height,a.height);let o=Math.min(e.canvas.width/a.width,e.canvas.height/a.height),n=a.width*o*s,h=a.height*o*s;console.log(i,d,n,h),e.clearRect(0,0,e.canvas.width,e.canvas.height),e.drawImage(a,i,d,n,h)}convert_to_dataURL(t){let e=document.getElementById("edc-"+t).toDataURL("image/"+this.edit_data[t].output_type);document.getElementById("out-"+t).value=e}onPointerUp(t){t.preventDefault();let e=t.target.id.split("-")[1];this.edit_data[e].active=!1,this.convert_to_dataURL(e)}onPointerDown(t){t.preventDefault();let e=t.target.id.split("-")[1];this.edit_data[e].active=!0,this.edit_data[e].drag_start_x=t.clientX/this.edit_data[e].zoom-this.edit_data[e].x,this.edit_data[e].drag_start_y=t.clientY/this.edit_data[e].zoom-this.edit_data[e].y}onPointerMove(t){t.preventDefault();let e=t.target.id.split("-")[1];this.edit_data[e].active&&(this.edit_data[e].x=t.clientX/this.edit_data[e].zoom-this.edit_data[e].drag_start_x,this.edit_data[e].y=t.clientY/this.edit_data[e].zoom-this.edit_data[e].drag_start_y,this.renderOnCanvas(e))}onMouseWheel(t){t.preventDefault(),console.log("mouse wheel");let e=t.target.id.split("-")[1];console.log(this.edit_data[e]),t.deltaY<0?this.edit_data[e].zoom=this.edit_data[e].zoom+.005:this.edit_data[e].zoom=this.edit_data[e].zoom-.005,this.renderOnCanvas(e),this.convert_to_dataURL(e)}}
